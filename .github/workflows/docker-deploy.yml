name: CI/CD Docker Deploy ğŸš€

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: ğŸ˜ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
        run: |
          echo "ğŸ” Commit SHA: ${{ github.sha }}"

      - name: ğŸ”– Define Version (short SHA)
        run: |
          echo "ğŸ” Full commit SHA: ${{ github.sha }}"
          VERSION=$(git rev-parse --short HEAD)
          echo "Detected short version from Git: $VERSION"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "ğŸ”– Version dÃ©finie en variable d'environnement: $VERSION"

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          echo "ğŸ“Œ Utilisation de la version: ${{ env.VERSION }}"
          echo "Commande de build: docker build -t rehanalimahomed/inoor-ocr:${{ env.VERSION }} -t rehanalimahomed/inoor-ocr:latest ."
          docker build -t rehanalimahomed/inoor-ocr:${{ env.VERSION }} -t rehanalimahomed/inoor-ocr:latest .
          echo "ğŸ—ï¸ Docker image construite avec succÃ¨s:"
          echo "   - Tag spÃ©cifique: rehanalimahomed/inoor-ocr:${{ env.VERSION }}"
          echo "   - Tag latest: rehanalimahomed/inoor-ocr:latest"

      - name: ğŸšš Push Docker Image to Docker Hub
        run: |
          echo "ğŸ“Œ Pousser l'image avec tag: rehanalimahomed/inoor-ocr:${{ env.VERSION }}"
          docker push rehanalimahomed/inoor-ocr:${{ env.VERSION }}
          echo "ğŸ“Œ Pousser l'image avec tag 'latest': rehanalimahomed/inoor-ocr:latest"
          docker push rehanalimahomed/inoor-ocr:latest
          echo "ğŸšš Images Docker poussÃ©es sur Docker Hub avec succÃ¨s!"

      - name: ğŸš€ Deploy New Container
        run: |
          CONTAINER_NAME=inoor-ocr
          echo "ğŸ“Œ DÃ©ploiement de l'image: rehanalimahomed/inoor-ocr:latest"
          echo "ğŸ“Œ Nom du container: ${CONTAINER_NAME}"
          echo "ğŸ“Œ Port exposÃ©: 3000"
          EXISTING_CONTAINER=$(docker ps -aq -f name=${CONTAINER_NAME})
          if [ "$EXISTING_CONTAINER" ]; then
            echo "ğŸ›‘ Container existant trouvÃ© (ID: ${EXISTING_CONTAINER}). ArrÃªt et suppression en cours..."
            docker stop ${CONTAINER_NAME} && docker rm ${CONTAINER_NAME}
          else
            echo "âœ… Aucun container existant trouvÃ© pour ${CONTAINER_NAME}"
          fi
          echo "ğŸš€ Lancement du nouveau container avec la politique de restart always..."
          docker run -d --restart always --name ${CONTAINER_NAME} -p 3000:3000 rehanalimahomed/inoor-ocr:latest
          echo "ğŸŠ Nouvelle instance dÃ©ployÃ©e avec succÃ¨s utilisant l'image rehanalimahomed/inoor-ocr:latest" 